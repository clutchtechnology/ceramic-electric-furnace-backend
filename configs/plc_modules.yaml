# ============================================================
# PLC 基础模块定义 (plc_modules.yaml)
# ============================================================
# 所有项目共享的基础模块类型定义
# 其他配置文件通过 module_ref 字段引用此文件中的模块定义
# 
# 使用方式:
#   在 config_*.yaml 中:
#     modules:
#       - name: my_sensor
#         module_ref: TemperatureSensor  # 引用此文件的模块定义
#         offset: 0
# ============================================================

# ============================================================
# 数据模块 (用于 DB32 等数据块)
# ============================================================
modules:

  # ----------------------------------------------------------
  # 红外测距传感器 (电极深度)
  # ----------------------------------------------------------
  InfraredDistance:
    size: 4  # UDInt = 4 bytes
    unit: "mm"
    description: 红外测距传感器 (UDInt 类型)
    fields:
      - name: distance
        offset: 0
        type: UDINT
        description: 测距值 (mm)

  # ----------------------------------------------------------
  # 压力传感器
  # ----------------------------------------------------------
  PressureSensor:
    size: 2  # Int = 2 bytes
    unit: "kPa"
    description: 压力传感器 (转换后单位 kPa)
    fields:
      - name: pressure
        offset: 0
        type: INT
        description: 压力值 (需转换, 原始值×0.01→kPa)

  # ----------------------------------------------------------
  # 流量传感器
  # ----------------------------------------------------------
  FlowSensor:
    size: 2  # Int = 2 bytes
    unit: "m³/h"
    description: 流量传感器 (转换后单位 m³/h)
    fields:
      - name: flow
        offset: 0
        type: INT
        description: 流量值 (需转换, 原始值×0.1→m³/h)

  # ----------------------------------------------------------
  # 蝶阀状态监测 (2字节/16位，每蝶阀2bit: 偶数位=关, 奇数位=开)
  # ----------------------------------------------------------
  # 结构说明:
  #   Byte 0 (I5): 蝶阀1-4
  #     - bit0 (I5.0): 蝶阀1关  bit1 (I5.1): 蝶阀1开
  #     - bit2 (I5.2): 蝶阀2关  bit3 (I5.3): 蝶阀2开
  #     - bit4 (I5.4): 蝶阀3关  bit5 (I5.5): 蝶阀3开
  #     - bit6 (I5.6): 蝶阀4关  bit7 (I5.7): 蝶阀4开
  #   Byte 1 (I6): 蝶阀5-8
  #     - bit0 (I6.0): 蝶阀5关  bit1 (I6.1): 蝶阀5开
  #     - bit2 (I6.2): 蝶阀6关  bit3 (I6.3): 蝶阀6开
  #     - bit4 (I6.4): 蝶阀7关  bit5 (I6.5): 蝶阀7开
  #     - bit6 (I6.6): 蝶阀8关  bit7 (I6.7): 蝶阀8开
  # ----------------------------------------------------------
  ValveStatusMonitor:
    size: 2  # 2 bytes = 16 bits (8个蝶阀 × 2bit/蝶阀)
    description: 蝶阀状态监测 (每蝶阀2bit, 偶数位=关, 奇数位=开)
    fields:
      - name: status_word
        offset: 0
        type: WORD
        description: 蝶阀状态字 (16bit, 每2bit表示1个蝶阀)
      # Byte 0: 蝶阀1-4
      - name: valve_1_close
        offset: 0.0
        type: BOOL
        description: 1号蝶阀关状态
      - name: valve_1_open
        offset: 0.1
        type: BOOL
        description: 1号蝶阀开状态
      - name: valve_2_close
        offset: 0.2
        type: BOOL
        description: 2号蝶阀关状态
      - name: valve_2_open
        offset: 0.3
        type: BOOL
        description: 2号蝶阀开状态
      - name: valve_3_close
        offset: 0.4
        type: BOOL
        description: 3号蝶阀关状态
      - name: valve_3_open
        offset: 0.5
        type: BOOL
        description: 3号蝶阀开状态
      - name: valve_4_close
        offset: 0.6
        type: BOOL
        description: 4号蝶阀关状态
      - name: valve_4_open
        offset: 0.7
        type: BOOL
        description: 4号蝶阀开状态
      # Byte 1: 蝶阀5-8
      - name: valve_5_close
        offset: 1.0
        type: BOOL
        description: 5号蝶阀关状态
      - name: valve_5_open
        offset: 1.1
        type: BOOL
        description: 5号蝶阀开状态
      - name: valve_6_close
        offset: 1.2
        type: BOOL
        description: 6号蝶阀关状态
      - name: valve_6_open
        offset: 1.3
        type: BOOL
        description: 6号蝶阀开状态
      - name: valve_7_close
        offset: 1.4
        type: BOOL
        description: 7号蝶阀关状态
      - name: valve_7_open
        offset: 1.5
        type: BOOL
        description: 7号蝶阀开状态
      - name: valve_8_close
        offset: 1.6
        type: BOOL
        description: 8号蝶阀关状态
      - name: valve_8_open
        offset: 1.7
        type: BOOL
        description: 8号蝶阀开状态

  # ----------------------------------------------------------
  # 继电器写入数组 (蝶阀控制输出)
  # ----------------------------------------------------------
  RelayWriteArray:
    size: 1  # 1 BYTE = 8 bits
    direction: WRITE
    description: 继电器写入数组 (Array[0..7] of Bool)
    fields:
      - name: bit_0
        offset: 0.0
        type: BOOL
      - name: bit_1
        offset: 0.1
        type: BOOL
      - name: bit_2
        offset: 0.2
        type: BOOL
      - name: bit_3
        offset: 0.3
        type: BOOL
      - name: bit_4
        offset: 0.4
        type: BOOL
      - name: bit_5
        offset: 0.5
        type: BOOL
      - name: bit_6
        offset: 0.6
        type: BOOL
      - name: bit_7
        offset: 0.7
        type: BOOL

  # ----------------------------------------------------------
  # 空气质量传感器 (PM10)
  # ----------------------------------------------------------
  AirQuality:
    size: 2  # WORD = 2 bytes
    unit: "μg/m³"
    description: 空气质量传感器 (PM10浓度)
    fields:
      - name: air_quality
        offset: 0
        type: WORD
        description: PM10浓度值

  # ----------------------------------------------------------
  # 温度传感器
  # ----------------------------------------------------------
  TemperatureSensor:
    size: 2  # WORD = 2 bytes
    unit: "°C"
    description: 温度传感器
    fields:
      - name: temperature
        offset: 0
        type: WORD
        description: 温度值 (需转换)

  # ----------------------------------------------------------
  # 振动传感器
  # ----------------------------------------------------------
  VibrationSensor:
    size: 8  # 2 REAL = 8 bytes
    description: 振动传感器
    fields:
      - name: amplitude
        offset: 0
        type: REAL
        unit: "mm/s"
        description: 振动幅值
      - name: frequency
        offset: 4
        type: REAL
        unit: "Hz"
        description: 振动频率

  # ----------------------------------------------------------
  # 运行状态模块
  # ----------------------------------------------------------
  RunningStatus:
    size: 2  # WORD = 2 bytes
    description: 设备运行状态
    fields:
      - name: status
        offset: 0
        type: WORD
        description: 状态字 (0=停止, 1=运行, 2=故障)

  # ----------------------------------------------------------
  # 电表模块 (完整14字段)
  # ----------------------------------------------------------
  ElectricityMeter:
    size: 56  # 14 REAL × 4 bytes = 56 bytes
    description: 三相电表 (电压/电流/功率/电能)
    fields:
      # 线电压 Uab (3相)
      - name: Uab_0
        offset: 0
        type: REAL
        unit: "V"
        description: AB线电压
      - name: Uab_1
        offset: 4
        type: REAL
        unit: "V"
        description: BC线电压
      - name: Uab_2
        offset: 8
        type: REAL
        unit: "V"
        description: CA线电压
      # 相电压 Ua (3相)
      - name: Ua_0
        offset: 12
        type: REAL
        unit: "V"
        description: A相电压
      - name: Ua_1
        offset: 16
        type: REAL
        unit: "V"
        description: B相电压
      - name: Ua_2
        offset: 20
        type: REAL
        unit: "V"
        description: C相电压
      # 电流 I (3相)
      - name: I_0
        offset: 24
        type: REAL
        unit: "A"
        description: A相电流
      - name: I_1
        offset: 28
        type: REAL
        unit: "A"
        description: B相电流
      - name: I_2
        offset: 32
        type: REAL
        unit: "A"
        description: C相电流
      # 功率
      - name: Pt
        offset: 36
        type: REAL
        unit: "kW"
        description: 总有功功率
      - name: Pa
        offset: 40
        type: REAL
        unit: "kW"
        description: A相功率
      - name: Pb
        offset: 44
        type: REAL
        unit: "kW"
        description: B相功率
      - name: Pc
        offset: 48
        type: REAL
        unit: "kW"
        description: C相功率
      # 累计电能
      - name: ImpEp
        offset: 52
        type: REAL
        unit: "kWh"
        description: 正向有功电能

# ============================================================
# 状态模块 (用于 DB30 等状态块)
# ============================================================
status_modules:

  # ----------------------------------------------------------
  # MB_COMM 通信初始化状态
  # ----------------------------------------------------------
  ModbusCommStatus:
    size: 4  # 4 bytes
    description: Modbus 通信初始化状态
    fields:
      - name: done
        offset: 0.0
        type: BOOL
        description: 初始化完成
      - name: error
        offset: 0.1
        type: BOOL
        description: 发生错误
      - name: status
        offset: 2
        type: WORD
        description: 状态码 (16#0 = 正常)

  # ----------------------------------------------------------
  # MB_MASTER 主站指令状态 (通用)
  # ----------------------------------------------------------
  ModbusMasterStatus:
    size: 4  # 4 bytes
    description: Modbus Master 指令状态
    fields:
      - name: done
        offset: 0.0
        type: BOOL
        description: 指令完成
      - name: busy
        offset: 0.1
        type: BOOL
        description: 指令执行中
      - name: error
        offset: 0.2
        type: BOOL
        description: 发生错误
      - name: status
        offset: 2
        type: WORD
        description: 状态码 (16#0 = 正常)

  # ----------------------------------------------------------
  # DataState 数据有效性状态
  # ----------------------------------------------------------
  DataStateStatus:
    size: 4  # 4 bytes (Bool + Padding + Word)
    description: 传感器数据有效性状态
    fields:
      - name: error
        offset: 0.0
        type: BOOL
        description: 数据错误
      - name: status
        offset: 2
        type: WORD
        description: 状态码

# ============================================================
# 数据类型定义 (字节大小参考)
# ============================================================
data_types:
  BOOL:
    size: 0.125  # 1 bit
    description: 布尔值
  BYTE:
    size: 1
    description: 8位无符号整数
  WORD:
    size: 2
    description: 16位无符号整数
  DWORD:
    size: 4
    description: 32位无符号整数
  INT:
    size: 2
    description: 16位有符号整数
  DINT:
    size: 4
    description: 32位有符号整数
  REAL:
    size: 4
    description: 32位浮点数 (IEEE 754)

# ============================================================
# 字节序说明
# ============================================================
# S7-1200 PLC 使用大端字节序 (Big Endian)
# Python 解析时使用: struct.unpack('>H', data)  # WORD
#                   struct.unpack('>f', data)  # REAL
